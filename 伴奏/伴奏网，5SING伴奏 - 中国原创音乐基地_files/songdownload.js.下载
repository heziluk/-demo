!function($){$.ksPlugin={alert:function(options,callback){var id="ksPlugin-alert-"+(new Date).getTime(),defaults={title:"温馨提示",yes:"确认",icon:"",yesClass:""};options=$.extend(!0,{},defaults,options),$.ksPlugin.showBackGround();var html='<div class="tip_box '+(""==options.icon?"w400_box":"s_icon")+'"  id="'+id+'"><div class="pop_tit"><span class="lt">'+options.title+'</span><a href="javascript:;" class="rt a_btn btn_close" title="关闭"><b class="m_btn">关闭</b></a></div><dl class="c_wap ct_com"><dt><table cellpadding="0" cellspacing="0" border="0"><tbody><tr><td class="tips '+options.icon+'"><i></i></td><td>'+options.content+'</td></tr></tbody></table></dt><dd class="c_wap act_btns"><a class="a_btn btn_yes '+options.yesClass+'" href="javascript:;">'+options.yes+"</a></dd></dl></div>";$("body").append(html),$("#"+id).find(".btn_yes").click(function(){$("#"+id).remove(),$.ksPlugin.hideBackGround(),callback&&callback()}),$("#"+id).find(".btn_close").click(function(){$("#"+id).remove(),$.ksPlugin.hideBackGround(),callback&&callback()})},confirm:function(options,callback,callbackno){var id="mb-"+(new Date).getTime(),defaults={title:"温馨提示",yes:"确认",no:"取消",icon:"",yesClass:"",noClass:"",width:""};options=$.extend(!0,{},defaults,options),$.ksPlugin.showBackGround();var html="";html='<div class="tip_box  '+(""==options.icon?"w400_box":"s_icon")+'" id="'+id+'" style="display:;'+(""!=options.width?"width:"+options.width:"")+'"><div class="pop_tit"><span class="lt">'+options.title+'</span><a href="javascript:;" class="rt a_btn btn_close" title="关闭"><b class="m_btn">关闭</b></a></div><dl class="c_wap ct_com"><dt><table cellpadding="0" cellspacing="0" border="0"><tbody><tr><td class="tips '+options.icon+'"><i></i></td><td>'+options.content+'</td></tr></tbody></table></dt><dd class="c_wap act_btns confirm"><a href="javascript:;" class="a_btn btn_yes '+options.yesClass+'">'+options.yes+'</a><a href="javascript:;" class="a_btn btn_no '+options.noClass+'">'+options.no+"</a></dd></dl></div>",$("body").append(html),$("#"+id).find(".btn_yes").click(function(){$("#"+id).remove(),$.ksPlugin.hideBackGround(),callback&&callback()}),$("#"+id).find(".btn_no").click(function(){$("#"+id).remove(),$.ksPlugin.hideBackGround(),callbackno&&callbackno()}),$("#"+id).find(".btn_close").click(function(){$("#"+id).remove(),$.ksPlugin.hideBackGround(),callbackno&&callbackno()})},success:function(message,delay,reload){var id="ksPlugin-success-"+(new Date).getTime(),html='<div class="tip_box tip_com" id="'+id+'"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tbody><tr><td class="t_icon"><i></i></td><td class="t_cons">'+message+"</td></tr></tbody></table></div>";$("body").append(html),delay=void 0==delay?2e3:delay,setTimeout(function(){$("#"+id).remove(),reload===!0?window.location.reload():reload&&(window.location.href=reload)},delay)},showLoading:function(id,message,delay){delay=void 0==delay?500:delay;var obj=setTimeout(function(){var html='<div class="tip_box tip_loding" id="'+id+'"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tbody><tr><td class="t_icon"><i></i></td><td class="t_cons">'+message+"</td></tr></tbody></table></div></div>";$("body").append(html)},delay);return obj},hideLoading:function(id,obj){null!=obj&&clearTimeout(obj),$("#"+id).length>0&&$("#"+id).remove()},faild:function(message,delay,reload){var id="ksPlugin-faild-"+(new Date).getTime(),html='<div class="tip_box tip_del" id="'+id+'"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tbody><tr><td class="t_icon"><i></i></td><td class="t_cons">'+message+"</td></tr></tbody></table></div></div>";$("body").append(html),delay=void 0==delay?2e3:delay,setTimeout(function(){$("#"+id).remove(),reload===!0?window.location.reload():reload&&(window.location.href=reload)},delay)},tips:function(message,delay,reload){var id="ksPlugin-normal-"+(new Date).getTime(),html='<div class="tip_box tip_normal" id="'+id+'"><table cellpadding="0" cellspacing="0" border="0" width="100%"><tbody><tr><td class="t_icon"></td><td class="t_cons">'+message+"</td></tr></tbody></table></div>";$("body").append(html),delay=void 0==delay?2e3:delay,$("#"+id).animate(),setTimeout(function(){$("#"+id).remove(),reload===!0?window.location.reload():reload&&(window.location.href=reload)},delay)},showBackGround:function(){if(0==$(".pop_lo_bg_bg").length){var style="<style>.pop_lo_bg_bg {background:rgba(0, 0, 0, 0); background:#0009; opacity:0\x00;position:fixed;width:100%;height:100%;top:0;left: 0;display:block;filter: Alpha(opacity=0);z-index: 11000;_position: absolute;_height: expression(document.body.clientHeight+'px');}.tip_confirm{position:fixed; top:50%; left:50%; margin-left:-200px; margin-top:-75px; width:400px; background:#fff; z-index:11001; _top:expression(documentElement.scrollTop+190);_position:absolute; _bottom:auto;}*html{background-image:url(about:blank);background-attachment:fixed;}.tip_confirm .tip_tit{height:40px; line-height:40px; background:#74bd52; border-bottom:#5eb13f solid 1px; color:#fff; font-size:16px; padding:0 10px;}.tip_confirm .tip_conbox{border:#e4e4e4 solid 1px; border-top:none; padding:10px; zoom:1;}.tip_confirm .tip_conbox p{font-weight:bold; text-align:center; font-size:14px; height:60px; line-height:40px;}.tip_confirm .tip_conbox a.lt:link,.tip_confirm .tip_conbox a.lt:visited{width:82px; height:30px; line-height:30px; text-align:center; text-decoration:none; color:#fff; display:inline;}.tip_confirm .tip_conbox a.cf_btn{margin-left:95px; background:#74bd54;}.tip_confirm .tip_conbox a.back_btn{margin-left:20px; background:#bfc1cd;}.tip_confirm .tip_conbox a.cf_btn:hover{background:#ff3000;}.tip_confirm .tip_conbox a.back_btn:hover{background:#a6a8b3;}</style>";$("head").append(style),$("body").append('<div class="pop_lo_bg_bg" style="display: none;"></div>')}$(".pop_lo_bg_bg").show()},hideBackGround:function(){$(".pop_lo_bg_bg").hide()},isPicUrl:function(url){var reg=/^(http:\/\/|https:\/\/).+(\.jpg|\.png|\.gif)$/i;return url.match(reg)?!0:!1},isUrl:function(url){var reg=/^(http:\/\/|https:\/\/).+/i;return url.match(reg)?!0:!1}};var URL="http://service.5sing.kugou.com/",getBaseName=function(songurl){var pos=songurl.lastIndexOf("/");return-1==pos?songurl:songurl.substr(pos+1)},ShowBox={waitpay:function(options){var data=$.extend({},{width:88,height:26,songid:"",songtype:""},options),html='<div class="opendown p_rel"><div class="close p_abs"><a href="javascript:void(0)" class="btn_close">×</a></div><div class="Result"><i></i><span class="f16">请在新打开的页面完成支付！</span><br>支付完成前请不要关闭此窗口</div><div class="bottom"><a class="btn Success down_success_btn down_pay_btn" data-songid="'+data.songid+'" data-songtype="'+data.songtype+'" href="javascript:void(0)" style="width:110px;"><span>支付成功并投喂</span></a>支付失败，重新<a href="http://5sing.kugou.com/my/pay/gedou" class="orangeTag" target="_blank">充值</a> </div></div>';this.show(html)},success:function(options){var data=$.extend({},{width:90,height:28,content:"",songid:"",songtype:"",songName:"",authorName:"",songName:"",songUrl:"",fileName:""},options),html='<div class="opendown p_rel"><div class="close p_abs"><a href="javascript:void(0)" class="btn_close">×</a></div><div class="title ell"><span title="'+data.songName+'">'+data.songName+'</span></div><div class="content">'+data.content+'</div><div class="bottom"><a class="btn" download="'+getBaseName(data.fileName)+'" href="'+(data.fileName?data.fileName:"javascript:void(0)")+'"><span>下载</span></a>'+(parseInt(data.songGd)>0?'在<a href="http://5sing.kugou.com/my/writing/buylog" target="_blank">作品管理-已购买歌曲</a>中查看购买记录':"")+'</div><div id="download_tips" style="color:#ff9000;margin-top:10px;">右键点击下载按钮，选择“链接另存为”</div>';this.show(html)},tips:function(options){var data=$.extend({},{songName:"",authorName:"",songGd:0,content:"",tips:"",disableClass:"",songid:"",songtype:"",width:88,height:26},options),html='<div class="opendown p_rel"><div class="close p_abs"><a href="javascript:void(0)" class="btn_close">×</a></div><div class="title ell"><span title="'+data.songName+'">'+data.songName+'</span></div><div class="content">立即投喂<span class="download_gd_num">'+parseInt(data.songGd)+"金豆</span>给音乐人，获得该歌曲的高清版本！<br>有你的支持，TA能在原创音乐的道路上走得更远！<br>"+data.content+' </div><div class="bottom"><a class="btn down_pay_btn '+data.disableClass+'" data-songid="'+data.songid+'" data-songtype="'+data.songtype+'" href="javascript:void(0)"><span>投喂</span></a>在<a href="http://5sing.kugou.com/my/writing/buylog" target="_blank">作品管理-已购买歌曲</a>中查看购买记录</div></div>';this.show(html)},show:function(html,needMask,callback){var id="download-"+(new Date).getTime(),needMask="undefined"==typeof needMask?!0:needMask;mask=1==needMask?'<div id="mask" style="position:fixed; position:absolute 9; top:0; left:0; opacity: 0.4; filter:alpha(opacity=40); width: 100%; height: 100%; z-index:1000; background-color:#333;"></div>':"",html=mask+'<div class="tip_box downloadBox w400_box"  id="'+id+'">'+html+"</div>",$("body").append(html),$("#"+id).find(".btn_yes").click(function(){$("#"+id).remove(),$.ksPlugin.hideBackGround(),callback&&callback()}),$("#"+id).find(".btn_close").click(function(){$("#"+id).remove(),$("#mask").remove(),$.ksPlugin.hideBackGround(),$("body").css("overflow","auto"),callback&&callback()})}},songOperate={apiUrl:{wealth:URL+"user/wealth",getPrice:URL+"song/getPermission"},init:function(){this.initFlash(),this.bindBtn()},initFlash:function(){$("head").append('<link href="http://static.5sing.kugou.com/release/song/v6.0.00/css/down_window.css" rel="stylesheet" type="text/css">'),$("head").append('<link href="http://static.5sing.kugou.com/release/space/v1.8.00/skin25/css/tipbox.css" rel="stylesheet" type="text/css">')},bindBtn:function(){$(document).on("click","#chargeBtn",function(e){e.preventDefault(),$(".opendown .btn_close").trigger("click"),ShowBox.waitpay({songid:$(this).attr("data-songid"),songtype:$(this).attr("data-songtype")}),window.open(e.target.getAttribute("href"))}),$(".action_down").live("click",function(e){e.preventDefault();var $this=$(this),songid=$this.attr("data-songid"),songtype=$this.attr("data-songtype"),typeArr=($(document).find(".action_down").index(this),{yc:1,fc:2,bz:3});if(!songid||!songtype){var href=$this.prop("href"),t=href.match(/^http:\/\/5sing.kugou.com\/(\w+)\/down\/(\d+)$/);if(!t)return!1;songid=t[2],songtype=t[1]}isNaN(parseInt(songtype))&&(songtype=typeArr[songtype]),$.ajax({url:songOperate.apiUrl.getPrice,type:"GET",data:{songId:songid,songType:songtype},dataType:"jsonp",jsonp:"jsoncallback"}).done(function(res){var tips={};if(0==res.success){switch(-1==res.code&&$.login(function(){location.reload()}),res.code){case-1:$.login(function(){location.reload()});break;case 1004:tips={songName:res.data.songName,authorName:res.data.authorName,songGd:res.data.songGd},res.data.userGd>=parseInt(res.data.songGd)?ShowBox.tips($.extend(!0,tips,{songid:songid,songtype:songtype,content:'（账户余额：<span id="download_balance">'+res.data.userGd+"</span>金豆）"})):ShowBox.tips($.extend(!0,tips,{disableClass:"fail",content:'(账户余额不足，请<a href="http://5sing.kugou.com/my/pay/jd" data-songid="'+songid+'" data-songtype="'+songtype+'" class="orangeTag" id="chargeBtn">充值</a>)'}));break;default:$.ksPlugin.faild(res.message,2e3)}return!1}1008==res.code?message="此歌曲免费！可以直接下载":1007==res.code?message="你是此歌曲的主人！可以直接下载":message="你已购买此歌曲！可以直接下载";var fileName=res.data.fileName||"";return tips={songName:res.data.songName,authorName:res.data.authorName,songGd:res.data.songGd,fileName:fileName},ShowBox.success($.extend(!0,tips,{content:message,songid:songid,songtype:songtype})),!1})}),$(".down_pay_btn").live("click",function(e){if($(this).hasClass("fail"))return!1;var $this=$(this),songid=$(this).attr("data-songid"),songtype=$(this).attr("data-songtype");if(songid&&songtype){if($this.hasClass("disabled"))return!1;$this.addClass("disabled"),$.ajax({url:"/my/songDownload/download",type:"POST",dataType:"json",data:{songid:songid,songtype:songtype}}).done(function(res){if($this.removeClass("disabled"),res.success!==!0)return $.ksPlugin.faild(res.message,1e3),!1;name=res.data.name,url=res.data.url;var $balance=$("#download_balance");if("1"!=$balance.attr("data-first")){var beforeGdNum=$balance.text(),needGdNum=parseInt($(".download_gd_num").text()),afterGdNum=beforeGdNum>=1&&beforeGdNum-needGdNum>=0?beforeGdNum-needGdNum:0;$balance.text(afterGdNum),$balance.attr("data-first","1")}$this.removeClass("down_pay_btn"),$this.attr("href",res.data.url).attr("download",getBaseName(res.data.url)),$("#download_tips").length<1&&$this.parent().after('<div id="download_tips" style="color:#ff9000;margin-top:10px;">右键点击下载按钮，选择“链接另存为”</div>'),$this.find("span").text("下载")})}})}};songOperate.init()}(jQuery);
